---
import { type CollectionEntry, getCollection, render } from "astro:content";
import SimilarBlogs from "../../components/blog/SimilarBlogs.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import MdLayout from "../../layouts/MdLayout.astro";
import { getReadingTime } from "../../lib/utils";
import { metadata } from "../../lib/constants";
import Breadcrumb from "../../components/Breadcrumb.astro";

export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<"blog">;

function formatDate(d: Date) {
	const fullDate = d.toLocaleString("en-us", {
		month: "long",
		day: "numeric",
		year: "numeric",
	});

	return fullDate;
}

const post = Astro.props;
const { Content, headings } = await render(post);

const time = getReadingTime(post.body ?? "");
const PAGE_TITLE = `${post.data.title} - Blog - ${metadata.title}`;
const publishedTime = post.data.publishedAt.toISOString();
const tags = post.data.tags || [];
---

<MainLayout
	title={PAGE_TITLE}
	description={post.data.summary}
	type="article"
	publishedTime={publishedTime}
	tags={post.data.tags}
>
	<section>
		<Breadcrumb
			items={[
				{ name: "Home", url: "/" },
				{ name: "Blog", url: "/blog" },
				{ name: post.data.title },
			]}
		/>

		<a
			href-lang="en-us"
			href="/blog"
			class="text-neutral-500 hover:text-neutral-600 dark:text-neutral-400 dark:hover:text-neutral-300 transition-colors"
		>
			← Back to Blog
		</a>

		<header class="mt-6 mb-8">
			<h1 class="balance font-semibold text-2xl md:text-4xl mb-4">
				{post.data.title}
			</h1>

			<div
				class="flex flex-wrap items-center gap-3 text-sm text-neutral-600 dark:text-neutral-400 mb-4"
			>
				<time datetime={publishedTime} class="flex items-center gap-1">
					<svg
						class="w-4 h-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
						></path>
					</svg>
					{formatDate(post.data.publishedAt)}
				</time>

				{
					time && (
						<>
							<span class="text-neutral-400">•</span>
							<span class="flex items-center gap-1">
								<svg
									class="w-4 h-4"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
									/>
								</svg>
								{time} min read
							</span>
						</>
					)
				}
			</div>

			{
				tags.length > 0 && (
					<div class="flex flex-wrap gap-2">
						{tags.map((tag) => (
							<a
								href={`/blog?tag=${encodeURIComponent(tag)}`}
								class="px-3 py-1.5 rounded-full bg-primary/20 hover:bg-primary/30 text-neutral-800 dark:text-neutral-200 text-sm font-medium transition-colors"
							>
								#{tag}
							</a>
						))}
					</div>
				)
			}
		</header>

		<article class="relative flex flex-col gap-4">
			<MdLayout headings={headings} backTo="/blog">
				<Content />
			</MdLayout>

			<SimilarBlogs blog={post} />
		</article>
	</section>
</MainLayout>
